<!DOCTYPE html>
<html lang="en">
  <head>
    <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    name="viewport"
  />
  <title>Drowning me></title>
  <link rel="stylesheet" href="/css/style.css">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

  </head>
  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">Drowning me</a>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
      <li class="menu-item">
        <a href="/" class="menu-item-link"
          >home</a
        >
      </li>
      
      <li class="menu-item">
        <a href="/categories" class="menu-item-link"
          >categories</a
        >
      </li>
      
      <li class="menu-item">
        <a href="/tags" class="menu-item-link"
          >tags</a
        >
      </li>
      
      <li class="menu-item">
        <a href="/archives" class="menu-item-link"
          >archives</a
        >
      </li>
      
      <li class="menu-item">
        <a href="/about" class="menu-item-link"
          >about</a
        >
      </li>
      
    </ul>
  </nav>
</header>
 <article class="post">
    <div class="post-title">
        <h2 class="title">for循环添加事件监听</h2>
    </div>
    <div class="post-meta">
        <span class="post-time">2019-10-19</span>
    </div>
    <div class="post-content">
        <h1 id="for循环添加事件监听"><a href="#for循环添加事件监听" class="headerlink" title="for循环添加事件监听"></a>for循环添加事件监听</h1><blockquote>
<p>在写某个需求时，想要做点击按钮动态添加样式表示选中的效果，在写 <code>js</code> 代码的时候遇到了疑问点。</p>
</blockquote>
<a id="more"></a>

<p><img src="/2019/10/19/for-xun-huan-tian-jia-shi-jian-jian-ting/for%E5%BE%AA%E7%8E%AF.png" alt="页面"></p>
<p>页面如上所示，头部的三个按钮在点击后永远只会对最后一个按钮进行样式添加或移除。</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">var</span> chooseArea <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">"choose-area"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>chooseArea<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chooseArea<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> child <span class="token operator">=</span> chooseArea<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  child<span class="token punctuation">.</span>onclick<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>className<span class="token operator">==</span><span class="token string">""</span><span class="token punctuation">)</span>
    child<span class="token punctuation">.</span>className<span class="token operator">=</span><span class="token string">"active"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>此处先拿出主要的代码(此时的已经是不完整+乱改版本)，部分打印代码为调试时编写。<br>查了一下百度，大概了解到是 <code>onclick</code> 或是添加事件监听一类都不是即时运行。而内部会调用外部的变量，在 <code>click</code> 事件的函数运行时，<code>i</code> 早已自增至最大值，所以永远指向最后一个元素。此处的解决方法是闭包。(我终于知道闭包的作用了…)</p>
<p>修改后的代码(依然有待改进，时间未定)：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">var</span> chooseArea <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">"choose-area"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>chooseArea<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chooseArea<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> child <span class="token operator">=</span> chooseArea<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>
      child<span class="token punctuation">.</span>onclick <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>className <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span>
          child<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">"active"</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
          child<span class="token punctuation">.</span>className<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>chooseArea<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span>j<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">else</span><span class="token punctuation">{</span>
            chooseArea<span class="token punctuation">.</span>children<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>className<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>闭包都解决不了的我可真是个菜鸡…(lll￢ω￢)</p>
<h2 id="2020-年的回顾"><a href="#2020-年的回顾" class="headerlink" title="2020 年的回顾"></a>2020 年的回顾</h2><p>这篇大概是最让我无奈的，现在我已经完全清楚笔记中记录的问题了。</p>
<p>一个很普遍简单的需求，多个按钮，监听按钮的点击事件来切换选中状态。</p>
<p>我们选择遍历按钮的 <code>dom</code> 类数组，如果仅仅采用 <code>ES5</code> 来完成，确实会遇到问题。</p>
<p>原因在于 <code>var</code> 声明的局限性， <code>var</code> 不存在块级作用域，在 <code>for</code> 循环内部声明的所有变量的作用域都是高于块级的，所有块级内部共享同样的变量，所以最后我们能找到的 <code>i</code> 是循环结束的值，所有按钮的点击事件都是触发最后一个按钮的样式变化。</p>
<p>此处的解决方法有：</p>
<ul>
<li>使用 <code>let</code> 声明块级作用域的变量。</li>
<li>调用立即执行函数形成闭包，也就是形成函数作用域来保存每一个 <code>i</code>  。</li>
</ul>

    </div>
</article>
 <footer>
  <p>
    Theme is <a href="/" target="_blank">Theme-example</a> by
    <a href="https://s1rine.github.io" target="_blank">Sirine</a>
  </p>
  <p>
    Powered by
    <a href="https://hexo.io/" target="_blank" rel="nofollow">hexo</a>
    &copy; 2021
  </p>
</footer>

    </div>
  </body>
</html>
